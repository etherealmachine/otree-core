<link
        rel="import"
        href="/static/bower_components/polymer/polymer.html" />
<link
        rel="import"
        href="/static/bower_components/polymerfire/firebase-document.html" />
<link
        rel="import"
        href="/static/webcomponents/otree-vars/otree-vars.html" />
<link
        rel="import"
        href="/static/webcomponents/otree-log/otree-log.html" />

<script src="heatmap.js"></script>

<!--
`<otree-bimatrix>` lets subjects select a strategy from a set of
possibilities. Their decision and the results are  displayed using the usual
matrix form.

Example:

    <otree-bimatrix
        row-labels='["Cooperate", "Defect"]'
        payoff-matrix=
        '[
            [
                "{{ Constants.cooperate_amount }}",
                "{{ Constants.cooperate_amount }}"
            ],
            [
                "{{ Constants.cooperate_defect_amount }}",
                "{{ Constants.defect_cooperate_amount }}"
            ],
            [
                "{{ Constants.defect_cooperate_amount }}",
                "{{ Constants.cooperate_defect_amount }}"
            ],
            [
                "{{ Constants.defect_amount }}",
                "{{ Constants.defect_amount }}"
            ]
            payoff-index='{{ player.id_in_group|add:"-1" }}'
        ]'>
    </otree-bimatrix>
-->
<dom-module id="otree-continuous-bimatrix">

    <template>

        <style>
            .highlight {
                background: #90CAF9;
            }

            :host {
                margin: 10px;
            }

            .payoff_labels {
                position: absolute;
                padding: 0;
                font-size: 9pt;
                font-weight: bold;
            }

            input[type=range]
            {
                writing-mode: bt-lr; /* IE */
                -webkit-appearance: slider-vertical; /* WebKit */
                width: 8px;
                height: 370px;
                padding: 0 5px;
                margin-top: 25px;
                margin-left: 15px;
                float: left;
            }

            #my-bimatrix-container {
                width: 430px;
                height: 420px;
            }

            #other-bimatrix-container {
                width: 300px;
                height: 300px;
                margin-bottom: 60px;
                margin-left: 20px;
            }

            #my-bimatrix-container, #other-bimatrix-container {
                display: inline-block;
                border: solid 2px orange;
            }

            #my-heatmap {
                width: 360px;
                height: 360px;
                margin-right: 15px;
                float: right;
            }

            #other-heatmap {
                width: 240px;
                height: 240px;
                margin: auto;
            }

            #my-heatmap, #other-heatmap {
                position: relative;
                margin-top: 30px;
            }

            #my-canvas, #other-canvas {
                position: absolute;
                display: block;
            }

            #my-val {
                position: absolute;
                bottom: 0;
                left: -2%;
                width: 104%;
                border-top: 2px solid black;
            }

            #other-val {
                position: absolute;
                height: 104%;
                right: 0;
                top: -2%;
                border-left: 2px solid black;
            }

        </style>

    <firebase-document
          id="fbdoc"
          path="[[path_]]"
          data="{{decisions}}">
    </firebase-document>

    <otree-vars id="vars"></otree-vars>

    <otree-log id="log"></otree-log>

        <div style="text-align: center">
            <div id="my-bimatrix-container">
                <input id="slider" type="range" min="0" max="1" step=".01" defaultValue=".5" on-up="_setMyDecision"/>
                <div id="my-heatmap">
                    <canvas width="360" height="360" id="my-canvas"></canvas>
                    <span class="payoff_labels" style="top: -25px; left: 10px;">[[_payoff(payoffMatrix.*, 0, payoffIndex)]]</span>
                    <span class="payoff_labels" style="top: -25px; right: 10px;">[[_payoff(payoffMatrix.*, 1, payoffIndex)]]</span>
                    <span class="payoff_labels" style="bottom: -25px; left: 10px;">[[_payoff(payoffMatrix.*, 2, payoffIndex)]]</span>
                    <span class="payoff_labels" style="bottom: -25px; right: 10px;">[[_payoff(payoffMatrix.*, 3, payoffIndex)]]</span>
                    <div id="my-val" style$="height: [[_calcPercent(my_decision)]];"></div>
                    <div id="other-val" style$="width: [[_calcPercent(other_decision)]];"></div>
                </div>
            </div>
            <div id="other-bimatrix-container" style="display: none">
                <div id="other-heatmap">
                    <canvas width="240" height="240" id="other-canvas"></canvas>
                    <span class="payoff_labels" style="top: -25px; left: 10px;">[[_payoff(payoffMatrix.*, 0, otherPayoffIndex)]]</span>
                    <span class="payoff_labels" style="top: -25px; right: 10px;">[[_payoff(payoffMatrix.*, 2, otherPayoffIndex)]]</span>
                    <span class="payoff_labels" style="bottom: -25px; left: 10px;">[[_payoff(payoffMatrix.*, 1, otherPayoffIndex)]]</span>
                    <span class="payoff_labels" style="bottom: -25px; right: 10px;">[[_payoff(payoffMatrix.*, 3, otherPayoffIndex)]]</span>
                    <div id="my-val" style$="height: [[_calcPercent(my_decision)]];"></div>
                    <div id="other-val" style$="width: [[_calcPercent(other_decision)]];"></div>
                </div>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'otree-continuous-bimatrix',
            properties: {
                rowLabels: Array,
                payoffMatrix: Array,
                payoffIndex: Number,
                opponentHeatmap: String,
                decisions: {
                    type: Object,
                    observer: '_decisionsChanged'
                },
                path_: String
            },
            listeners: {
                'keyup' : '_setMyDecision'
            },
            ready: function() {
                this.path_ = (
                    '/component/otree-bimatrix' +
                    '/session/' + this.$.vars.session +
                    '/subsession/' + this.$.vars.subsession +
                    '/round/' + this.$.vars.round +
                    '/group/' + this.$.vars.group +
                    '/decisions');
                this.my_decision = .5;
                this.other_decision = .5;
                this.otherPayoffIndex = this.payoffIndex == 0 ? 1 : 0;

                // extract the set of payoffs corresponding to this player's payoff index
                my_payoffs = this.payoffMatrix.map(function (current_val) {
                    return current_val[this.payoffIndex];
                }, this);
                make_heatmap("my-canvas", my_payoffs);

                if (this.opponentHeatmap == "true") {
                    this.$["other-bimatrix-container"].style.display = "";
                    other_payoffs = this.payoffMatrix.map(function (current_val) {
                        return current_val[this.otherPayoffIndex];
                    }, this);
                    var tmp = other_payoffs[1];
                    other_payoffs[1] = other_payoffs[2];
                    other_payoffs[2] = tmp;
                    make_heatmap("other-canvas", other_payoffs);
                }

            },
            _equals(d, decision) {
                return d == decision;
            },
            _setMyDecision(event) {
                if (event.type === 'keyup' && !(event.key === 'ArrowDown') && !(event.key === 'ArrowUp')) {
                    return;
                }
                var d = parseFloat(event.target.value);
                if (this.decisions === null) {
                    this.decisions = {};
                }
                var pcode = this.$.vars.participantCode;
                this.set('decisions.' + pcode, d);
                this.my_decision = d;
            },
            _decisionsChanged() {
                if (this.decisions === null) {
                    return;
                }
                var pcode = this.$.vars.participantCode;
                if (this.decisions[pcode]) {
                    this.my_decision = this.decisions[pcode];
                    this.$.slider.value = this.my_decision;
                }

                // get other player's decision by picking the key that isn't yours
                // there's probably a better way of doing this
                for (var key in this.decisions) {
                    if (key != pcode) {
                        this.other_decision = this.decisions[key];
                        break;
                    }
                }
            },
            _calcPercent(decision) {
                return decision * 100 + "%";
            },
            _payoff: function(change, x, y) {
                return change.base[x][y];
            }
        });
    </script>

</dom-module>